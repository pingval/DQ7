# [PS版DQ7 アニメティカ使用セーブデータ改竄RTA 配信ガイドライン対応版 in 4:13](https://www.youtube.com/watch?v=1leEccsh_qA)

- プレイ日時: 2021年01月30日
- 計測区間: 本体の電源投入から<strong>ラスボス撃破(「～をやっつけた！」表示)</strong>まで
- 使用ソフト:
  - RPGツクール3
  - PS版DQ7 アルティメットヒッツ版(いわゆる廉価版)
- 使用本体: PS2(SCPH-90000)
- 使用コントローラ: Sony SCPH-10010
- 改ざん用のセーブデータ作成を計測区間に含める（事前に作成したセーブデータの利用は禁止！）
- RTAで使用するブロックの書き込みを終えるまで、アニメティカ無圧縮セーブ中のメモリーカードの抜き差しは禁止
  - DQ7の場合、`7-1=6`なので無圧縮セーブ中「残り 6ブロック」と表示されたらメモリーカードを引き抜いてよい

----

## [自分の2:19](./rta-saveglitch-20190910-00h02m19s.md)からの変更点など

> エンディング部分の生配信、動画・画像の投稿は禁止いたします。エンディング部分とは、『ドラゴンクエストVII』の最終決戦のバトル終了後から、「The End」「To be Continued」「Fin」といった表記が表示される、あるいは自動的にタイトル画面に戻るといった物語の終了が示されるまでの区間を指します。

- という、2021/01/14に公開された[「ドラゴンクエスト」シリーズ作品の動画・生配信・画像投稿に関するガイドライン](https://www.dragonquest.jp/guideline/)の記述に従って計測終了地点を「THE END画面の羽ペン消失」から「ラスボス撃破」に変更。従来スキップしていたラスボスと戦うため、お絵かきを全面的に変更。
- 2020/01に発見されていた[PS2本体のメモリーカード間コピー機能を利用した管理ブロック(セーブデータのヘッダ)改竄]((https://github.com/pingval/Speedrun/blob/master/Xenogears/rta-saveglitch-20200129-00h19m49s.md#ps2%E6%9C%AC%E4%BD%93%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%BC%E3%82%AB%E3%83%BC%E3%83%89%E9%96%93%E3%82%B3%E3%83%94%E3%83%BC%E6%A9%9F%E8%83%BD%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E7%AE%A1%E7%90%86%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E6%94%B9%E7%AB%84))の導入。これによってメモリーカード引き抜きの猶予が約0.03sから**約1.2s**と大幅に延び安定した代わりに約25sのロス。一発勝負向け。

## 戦略概要

### セーブデータ詳細
```
0x4180..0x41ff:
  0x4180..0x4185: 20 00 00 02 00 00 ;; セーブデータを128byteの塊ごとに読み込むかどうかのフラグ
  0x4190..0x4193: d0 07 08 00 ;; 固定
  0x41ae..0x41af: de 06 ;; MapID: 1758
0x4400..0x447f:
  0x440d: val & 0x04 != 0 ;; オルゴ即戦闘(神さまにワープさせてもらった)フラグ
0x4e00..0x4e7f:
  0x4e2c: 03 ;; ミミックの石1byte目 (アイテム欄1個目)
  0x4e2d: (val & 0x01) == 0 && (val & 0x02) != 0 ;; ミミックの石2byte目
  ;; 0x4e30..0x4e43, # アイテム欄 3~12
  0x4e4e: (val & 0x1f) == 0x01 ;; キャラ
  0x4e5e..0x4e5f: (val[0] >> 4) | ((val[1] & 0x3f) << 4) > 0 ;; 現在HP
  0x4e62..0x4e63: (val[0] >> 4) | ((val[1] & 0x3f) << 4) >= 270 ;; 素早さ
```

- 素直にやると`0x4180..0x41ff`, `0x4400..0x447f`, `0x4e00..0x4e7f`の塊3個を個別にチェックサム調整することになるが、それはめんどいので全ての要件を満たす塊を描いて残り2箇所にコピペした。コピペ最高！
- `0x4180`の`20`は`0x4400..0x447f`(オルゴ即戦闘フラグ)を読み込むのに必要。
- `0x4183`の`02`は`0x4e00..0x4e7f`(アイテム・キャラ・ステータス)を読み込むのに必要。
- ロード開始～オルゴ戦開始をNO$PSXで計測すると以下のようになった。愚直にオルゴ戦前から始めるよりも、神さまにオルゴの目の前へ飛ばしてもらう方が16.5s速い。しかしオルゴ即戦闘フラグを立てた状態でオルゴ戦前から始めれば更に19s速い。
  - MapID 1758 (オルゴ戦前): 47s
  - MapID 1784 (神さま戦前): 30.5s
  - **MapID 1758 && オルゴ即戦闘フラグ: 11.5s**
- 撃破手段はミミックの石一択だろう。**耐性を貫通して敵全体に一撃死の効果**を持つデバッグアイテム。必要なステータスは(現在HPと)先攻率を確保するための素早さだけだ。
  - アイテム欄の1-12番目どこに置いてもいいが、1番目に置いているのは、コピペのためにデータを共有している影響でアイテム欄2番目にMapIDが存在し、更にその影響で3~12番目に置いた場合は連打でミミックの石を選択できなくてめんどいため。
- 現在HPは0だと戦闘に入った瞬間死んで全滅するので**1以上**必要。
- オルゴ2の4形態のうち最も素早さが高いのは第2形態で135。[DQ7では素早が2倍あれば確定先攻](http://pingval.g1.xrea.com/dq7/research/#actorder)なのでこちらは**270以上**あればOK。
  - 素早さは245もあれば先攻率99%でほぼ問題ないようだが。
- デバッグモードのみ有効にしたセーブデータをロードしてデバッグメニューから全部やる案も考えたが、デバッグモード有効のセーブデータは作れないっぽい。残念。

### 色塗り
- 主人公のステータスはLv5、現在HP464、素早さ528、それ以外は0。チェックサム調整の影響で毒状態になっているが、特に問題はない。
  - 最大HPも**0**。この場合攻撃を喰らうと一発で死ぬため、**コマンド入力ミスは厳禁**。
- なお、このデータでエンディングを進めると、主人公が棺桶だったり、「しらべる」するとフリーズしたり、神の石が常に正面を向いていたり、メザレやホビットの洞窟や海賊船の自動移動で視点がすっ飛んで画面が真っ暗になったりする。フィッシュベルには辿り着けるのでTHE END画面はどうにか見れるかと思いきや、自宅1Fで梯子から降りれなくて詰む。THE END画面をちゃんと見たい人は最大HP(0x4e5c)を1以上に書き換えよう！
```
Hex(0x4180, 0x4400, 0x4e00):
20 00 00 02 00 00 00 00 00 00 00 00 00 07 00 00
d0 07 08 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 03 de de 06
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 a1 00
00 00 00 00 00 00 00 00 00 1d 00 00 00 00 00 1d
00 00 00 a1 00 00 00 00 1d 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00
AnimeMaker(used block: #2):
  20: ( 32, 27)
  02: ( 35, 27)
  07: ( 45, 27)
  D0: ( 48, 27)
  07: ( 49, 27)
  08: ( 50, 27)
  03: ( 76, 27)
  DE: ( 77..78, 27)
  06: ( 79, 27)
  A1: (110, 27)
  1D: (121, 27)
  1D: (127, 27)
  A1: (131, 27)
  1D: (136, 27)
  20: ( 96, 29)
  02: ( 99, 29)
  07: (109, 29)
  D0: (112, 29)
  07: (113, 29)
  08: (114, 29)
  03: (140, 29)
  DE: (141..142, 29)
  06: (143, 29)
  A1: (174, 29)
  1D: (185, 29)
  1D: (191, 29)
  A1: (195, 29)
  1D: (200, 29)
  20: ( 64, 38)
  02: ( 67, 38)
  07: ( 77, 38)
  D0: ( 80, 38)
  07: ( 81, 38)
  08: ( 82, 38)
  03: (108, 38)
  DE: (109..110, 38)
  06: (111, 38)
  A1: (142, 38)
  1D: (153, 38)
  1D: (159, 38)
  A1: (163, 38)
  1D: (168, 38)
Visual:
y\x| 32       35                            45       48 49 50                                        64       67                         76 77 78 79 80 81 82                                        96       99                        108109110111112113114                  121               127         131            136         140141142143                           153               159         163            168               174                              185               191         195            200
---+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 27| 20       02                            07       D0 07 08                                                                            03 DE DE 06                                                                                           A1                               1D                1D          A1             1D                                                                                                                                                                                                
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 29|                                                                                                                                                                                                 20       02                            07       D0 07 08                                                                            03 DE DE 06                                                                                           A1                               1D                1D          A1             1D
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 38|                                                                                                 20       02                            07       D0 07 08                                                                            03 DE DE 06                                                                                           A1                               1D                1D          A1             1D                                                                                                
```
- [攻略チャート](./psdq7-saveglitch-guideline-chart.txt)
- [お絵描き手順](./psdq7-saveglitch-guideline-ss.md)
- [その他の候補](./dq7-guideline-checksum0.txt)
- [探索に用いたスクリプト](./dq7_guideline_checksum_search.rb)

----

## タイムいろいろ

|区間名|通過|区間|戦闘|備考|
|:---:|:---:|:---:|:---:|:---:|
|電源投入|00:00:00|||
|アニメティカ終了|00:02:24|00:02:24|||
|オルゴ2撃破|00:04:13|00:01:49|||

- 計測地点:
  - アニメティカ終了: アニメティカ起動中にリセットした瞬間
  - オルゴ2撃破: 「オルゴ・デミーラをやっつけた！」と表示された瞬間

----

## 実際のプレイ

- 戦闘開始時のメッセージ速度変更が遅い。

----

## おわりに

- 今までのアニメティカDQ7はラスボスと戦っていないため他のちゃんとしたやつと違って計測終了地点の変更による配信ガイドライン対応ができないのと、ラスボス撃破する戦略も今まで得た知見を活かせばさほど苦労せず作れそうだと思ったのが動機。
- お絵描きはまだ速くなるので安定ヘッダ改竄を使ったままでも4m10sは切れるだろう。指が悴む冬は嫌い。

----

## 参考

- [プレイステーション・ＰＡＤ／メモリ・インターフェースの解析](http://kaele.com/~kashima/games/ps_jpn.txt)
- [RPGツクール3を使ったPS1セーブデータの改ざん方法 | RTAPlay!](https://rta-play.info/tool/save-glitch/)
- [【ゆっくり実況】ドラゴンクエスト7 セーブデータ改ざんRTA　0:14:04](https://www.nicovideo.jp/watch/sm35205981)
- [巡回冗長検査 - Wikipedia](https://ja.wikipedia.org/wiki/%E5%B7%A1%E5%9B%9E%E5%86%97%E9%95%B7%E6%A4%9C%E6%9F%BB)
- [resilar/crchack: Reversing CRC for fun and profit](https://github.com/resilar/crchack)
- [PlayStation®版 『ドラゴンクエストVII　エデンの戦士たち』動画・生配信・画像投稿に関するガイドライン | ドラクエ・パラダイス(ドラパラ)ドラゴンクエスト公式サイト | SQUARE ENIX](https://www.dragonquest.jp/guideline/dq7/ps/)
- [6.1. デバッグモード](https://showa-yojyo.github.io/dqbook/dq7_dbg.html)
